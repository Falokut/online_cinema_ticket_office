
worker_processes auto;
worker_cpu_affinity auto;
worker_rlimit_nofile 30000;

pcre_jit on;

events {
  worker_connections 8192;
}


http {
  include services.conf;
  include rules.conf;
  grpc_read_timeout 300ms;
  grpc_send_timeout 300ms;
  grpc_buffer_size 300M;

  server {
    listen 8080;
    location /stub_status {
      access_log  /dev/null;
      stub_status;
    }
  }
  
  server {
    listen 80 default_server;
    listen [::]:80 default_server;
    http2 on;
    # for certbot
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
      add_header 'Access-Control-Allow-Origin' '*';
      return 308 https://www.falokut.ru$request_uri;
    }
  }


  server {
    listen 443 ssl default_server;
    listen [::]:443 default_server;
    server_name www.falokut.ru;
    http2  on;

    # ssl settings
    ssl_certificate /certs/falokut.ru.crt;
    ssl_certificate_key /certs/falokut.ru.key;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_cache   shared:SSL:100m;
    ssl_session_timeout 10m;
    #-------------
    client_max_body_size 10m;
    error_page 497 https://$server_name$request_uri;

    location / {
      # only for disabling CORS
      if ($request_method = 'OPTIONS') {
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Credentials' 'false' always;
        add_header 'Access-Control-Allow-Headers' '*' always;
        add_header 'Access-Control-Allow-Methods' '*' always;
        add_header 'Access-Control-Max-Age' 1728000;
        add_header 'Content-Type' 'text/plain; charset=utf-8';
        add_header 'Content-Length' 0;
        return 204;
      }
      proxy_request_buffering off;
      proxy_buffering off;
      proxy_connect_timeout  600s;
      proxy_send_timeout  600s;
      proxy_read_timeout  600s;
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Headers' '*' always;
      add_header 'Access-Control-Allow-Methods' '*' always;
      add_header 'Access-Control-Allow-Credentials' 'false' always;
      if ($server_protocol ~* "HTTP/2.0") {
          grpc_pass grpc://localhost:3000;
      }
      proxy_pass http://localhost:3000;
    }

    location /payment-stub {
      return 200;
    }
  }

  # public endpoints
  server {
    listen 3000 default_server;
    listen [::]:3000;
    http2  on;

    client_max_body_size 10m;
    server_name $host;
    
    location @unauth {
      return 401;
    }

    location /auth {
      internal;
      error_page 404 400 401 =401 @unauth;
      proxy_set_header X-Machine-Id $http_x_machine_id;
      proxy_pass_request_body off;
      proxy_intercept_errors on;
      auth_request_set $http_x_account_id $upstream_http_x_account_id;
      proxy_pass http://accounts_services/v1/account-id;
    }
    
    location /api/accounts-service/account-id {
      error_page 404 400 401 =401 @unauth;
      proxy_intercept_errors on;
      proxy_set_header X-Machine-Id $http_x_machine_id;
      proxy_pass_request_body off;
      auth_request_set $http_x_account_id $upstream_http_x_account_id;
      proxy_pass http://accounts_services/v1/account-id;
    }

    #------------------------------
    location /api/accounts-service/ {
      proxy_pass http://accounts_services/v1/;
      proxy_set_header X-Machine-Id $http_x_machine_id; 
    }

    location /api/accounts-service/verify/ {
      proxy_method POST; 
      proxy_pass http://accounts_services/v1/verification/;
    }

    location /api/orders-service/ {
      proxy_pass http://orders_services/v1/;
    }

    location /api/orders-service/order/ {
      auth_request_set $http_x_account_id $upstream_http_x_account_id;
      proxy_set_header X-Machine-Id $http_x_machine_id;
      proxy_set_header X-Account-Id $http_x_account_id;
      proxy_set_header X-Session-Id $http_x_session_id;
      auth_request /auth;
      proxy_pass http://orders_services/v1/order/;
    }

    location /api/orders-service/orders {
      auth_request_set $http_x_account_id $upstream_http_x_account_id;
      proxy_set_header X-Machine-Id $http_x_machine_id;
      proxy_set_header X-Account-Id $http_x_account_id;
      proxy_set_header X-Session-Id $http_x_session_id; 
      auth_request /auth;
      proxy_pass http://orders_services/v1/orders;
    }

    location ~ /api/orders-service/reservation/(.+)/process {
      auth_request_set $http_x_account_id $upstream_http_x_account_id;
      proxy_set_header X-Machine-Id $http_x_machine_id;
      proxy_set_header X-Account-Id $http_x_account_id;
      proxy_set_header X-Session-Id $http_x_session_id; 
      auth_request /auth;
      proxy_pass http://orders_services/v1/reservation/$1/process;
    }


    location /api/profiles-service/ {
      auth_request_set $http_x_account_id $upstream_http_x_account_id;
      proxy_set_header X-Machine-Id $http_x_machine_id;
      proxy_set_header X-Account-Id $http_x_account_id;
      proxy_set_header X-Session-Id $http_x_session_id; 
      auth_request /auth;
      proxy_pass http://profiles_services/v1/;
    }
    #------------------------------

    location /api/images-service/ {
      client_max_body_size 50m;
      proxy_pass http://images_storage_services/v1/;
    }

    location /api/image-processing-service/ {
      proxy_pass http://image_processing_services/v1/;
    }

    location /api/images-service/image/ {
      proxy_cache images_cache;
      proxy_pass http://images_storage_services/v1/image/;
    }
    
    location /image/ {
      proxy_cache images_cache;
      proxy_pass http://images_storage_services/v1/image/;
    }

    #------------------------------

    location /api/movies-service/ {
      proxy_pass http://movies_services/v1/;
    }

    location /api/cinema-service/ {
      proxy_pass http://cinema_services/v1/;
    }


    location /api/movies-persons-service/ {
      proxy_pass http://movies_persons_services/v1/;
    }

    location /api/casts-service/ {
      proxy_pass http://casts_services/v1/;
    }
    #------------------------------
    location /images_storage_service.ImagesStorageServiceV1/ {
      grpc_pass grpc://images_storage_services;
    }

    location /image_processing_service.ImageProcessingServiceV1/ {
      add_header CONTENT_LENGTH $content_length;
      client_max_body_size 200m;
      chunked_transfer_encoding off;
      grpc_pass grpc://image_processing_services;
    }

    location /images_storage_service.ImagesStorageServiceV1/GetImage {
      proxy_cache images_cache;
      grpc_pass grpc://images_storage_services;
    }

    location /accounts_service.accountsServiceV1/ {
      grpc_set_header X-Machine-Id $http_x_machine_id; 
      grpc_pass grpc://accounts_services;
    }
    
    location /profiles_service.profilesServiceV1/ {
      auth_request_set $http_x_account_id $upstream_http_x_account_id;
      grpc_set_header X-Account-Id $http_x_account_id;
      grpc_set_header X-Machine-Id $http_x_machine_id;
      grpc_set_header X-Session-Id $http_x_session_id; 
 
      auth_request /auth;
      grpc_pass grpc://profiles_services;
    }

    location /movies_persons_service.moviesPersonsServiceV1/ {
      grpc_pass grpc://movies_persons_services;
    }

    location /movies_service.moviesServiceV1/ {
      grpc_pass grpc://movies_services;
    }

    location /casts_service.castsServiceV1/ {
      grpc_pass grpc://casts_services;
    }

    location /cinema_service.cinemaServiceV1/ {
      grpc_pass grpc://cinema_services;
    }
  }
}

